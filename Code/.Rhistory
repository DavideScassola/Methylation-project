return(ecdf(msr_samples(l, prop, sample_size, verbose = F, cores = cores)))
}
get_msr_ecdfs <- function(l, prop_list, sample_size, cores = 1)
{
sapply(prop_list, function(prop)
{
if(prop==0 || prop==1) e = NA
else e = get_msr_ecdf(l, prop, sample_size, cores = cores)
return(List(cdf = e, prop=prop))
})
}
inverse = function(f, lower = -100, upper = 100) {
function (y) uniroot((function (x) f(x) - y), lower = lower, upper = upper)[1]$root
}
msr_confidence_line <- function(ecdfs, confidence = 0.99)
{
sapply(ecdfs, function(f)
{
if( f$prop==0 || f$prop==1) return(c(f$prop,NA))
c(f$prop, inverse(f$cdf, 0, 0.4)(confidence))
})
}
add_msr_confidence_line <- function(ecdfs, confidence = 0.99, col = 1, lty = 2)
{
conf = msr_confidence_line(ecdfs, confidence)
lines(conf[1,], conf[2,], col=col, lty=lty)
}
general_msr_cdf <- function(ecdfs, density, msr)
{
for( i in 1:length(ecdfs))
{
if(density>= ecdfs[[i]]$prop & density<= ecdfs[[i+1]]$prop)
{
dist1 = density - ecdfs[[i]]$prop
dist2 = ecdfs[[i+1]]$prop - density
w = dist1/(dist1+dist2)
return(ecdfs[[i]]$cdf(msr)*(1-w)+(w)*ecdfs[[i+1]]$cdf(msr))
}
}
}
#setwd("./Scrivania/Tesi/MethylationCode/")
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
#cell_files <- list.files(directory,pattern="(_converted.Rda)$")
#cell_names <- sub("_converted.Rda","", cell_files)
#methylation_vector <- as.logical(readRDS("MethylationData/binary_rate/GSM3436261_O1_TA_Hi_10_converted.Rda"))
sample_msr(1e6, 0.5)
msr_samples(1e6, 0.05, 10, verbose = T)
msr_samples(1e5, 0.05, 10, verbose = T)
2*20*1e4
2*20*1e4/18
2*20*1e4/18/3600
2*25*1e4/18/3600
2*25*1e3/18/3600
2*25*4e3/18/3600
2*25*5e3/18/3600
2*25*1e4/18/3600
2*25*1e4/20/3600
setwd(dir = "Scrivania/Tesi/Methylation-project/Code/")
source("WGBS_analysis_functions.R", chdir = T)
############################################################
file = "../../MethylationCode/MethylationData/enhancer.bed"
Enhancers <- fread(verbose=F, showProgress=T, stringsAsFactors = T)
Enhancers <- fread(file = file,verbose=F, showProgress=T, stringsAsFactors = T)
Enhancers$chr
Enhancers
Enhancers[-c("strand", "anno")]
Enhancers[, -c("strand", "anno")]
Enhancers = Enhancers[, -c("strand", "anno")]
Enhancers
add_chr <-function(chr_number)
{
paste("chr", as.character(chr_number), sep="")
}
to_chr_factor <-function(chr_number)
{
paste("chr", as.character(chr_number), sep="")
}
to_chr_factor(2)
to_chr_factor(X)
to_chr_factor(X)
to_chr_factor("X")
to_chr_factor = Vectorize(to_chr_factor)
to_chr_factor(2)
to_chr_factor(2,2)
to_chr_factor(c(2,5,6))
to_chr_factor(Enhancers$chr)
a = Factor(to_chr_factor(Enhancers$chr))
a
as.factor(a)
a = as.Factor(to_chr_factor(Enhancers$chr))
a = as.factor(to_chr_factor(Enhancers$chr))
a
Enhancers$chr
Enhancers$chr = a
Enhancers
save(Enhancers, file = "../../MethylationCode/MethylationData/Enhancers,Rdata")
load("../../MethylationCode/MethylationData/Enhancers,Rdata")
remove(Enhancers)
load("../../MethylationCode/MethylationData/Enhancers,Rdata")
object.size(Enhancers)
a = ordered_data(Enhancers)
a
sort(a)
a[order(a$start),]
a = a[order(a$start),]
a = ordered_data(a)
a
a$chr
a
Enhancers
to_chr_factor <- Vectorize(function(chr_number)
{
paste("chr", as.character(chr_number), sep="")
})
file_h1 <- "../../MethylationCode/MethylationData/wgbs/H1.Rda"
data_H1 <- readRDS(file_h1)
data_H1$chr
filter_annotation_region("chr5", 123, 4566, data_H1)
filter_annotation_region <- function(chromosome, start, end, data)
{
data[chr==chromosome & Cpos>=start & Cpos<=end]
}
get_annotation_region <- function(n, data, Annotations_dataframe)
{
i = Annotations_dataframe[n]
filter_annotation_region(as.character(i$chr), i$start, i$end, data)
}
show_annotation_region <- function(n, data, min_reads = 2, Annotations_dataframe)
{
d = get_annotation_region(n, data)
d[reads<min_reads]$prop = NA
minus <- d$strand=="-"
plus <- d$strand=="+"
xlabel = paste("nucleotide position on ", as.character(Annotations_dataframe[n]$chr))
plot(d[plus]$Cpos, d[plus]$prop, ylim = c(0,100), col = 2, xlab = xlabel, ylab = "observed meth proportion")
points(d[minus]$Cpos, d[minus]$prop, col = 4)
points(d[reads<min_reads]$Cpos, rep_len(50, length(d[reads<min_reads]$Cpos)), col = "gray65", pch = "|")
lines(x = c(0,9999999999), y = c(50,50), lty = 2)
cat("annotation region infos:\n ")
print(Annotations_dataframe[n])
}
compare_annotation_region <- function(n, min_reads = 5, ...)
{
par(mfrow=c(length(list(...)),1))
for(d in list(...))
{
show_annotation_region(n, d, min_reads = min_reads)
}
}
annotation_region_meth_counter1 <- function(annotation_region)
{
isl = annotation_region[reads>2, prop]
meth_count = sum(isl>50)
c(mean(isl), meth_count, length(isl))
}
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, cores = 1, Annotations_dataframe)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
gc()
return(r)
}
aggregate <- function(d, bin_size, chromosome, limiter = 99999999)
{
df = filter_chromosome(d,chromosome)
l = max(df$Cpos)
f = min(df$Cpos)
len = floor((l-f)/bin_size)
len = min(len,limiter)
cat("len: ", len)
starting_points = (((1:len)-1)*bin_size)+f
sapply(starting_points, function(s)
{
mean(df[df$Cpos>=s & df$Cpos<(s+bin_size)]$prop, na.rm = T)
})
}
get_annotation_region_ranges <- function(data, min_reads = 2, Annotations_dataframe)
{
cat("\npreprocessing . . .\n")
d = sum_strands(data)
d = d[reads>=min_reads, chr, Cpos]
l_isl = length(Annotations_dataframe$start)
l_data = length(data$prop)
ranges = array(dim = c(l_isl,2))
cat("computing indexes\n")
indexes = mcmapply(1:l_isl, mc.silent = F, mc.cores = 1, FUN =  function(n)
{
cat(n," ")
i_start = Annotations_dataframe[n, start]
i_end = Annotations_dataframe[n, end]
i_chr = Annotations_dataframe[n, chr]
s = match()
c(d[Cpos = ])
})
}
filter_annotation_region("chr5", 123, 4566, data_H1)
filter_annotation_region("chr5", 123, 45663, data_H1)
get_annotation_region(1, data_H1, Enhancers)
show_annotation_region(1, data_H1, 2, Enhancers)
show_annotation_region(1, data_H1, Enhancers)
show_annotation_region <- function(n, data, Annotations_dataframe,  min_reads = 2)
{
d = get_annotation_region(n, data)
d[reads<min_reads]$prop = NA
minus <- d$strand=="-"
plus <- d$strand=="+"
xlabel = paste("nucleotide position on ", as.character(Annotations_dataframe[n]$chr))
plot(d[plus]$Cpos, d[plus]$prop, ylim = c(0,100), col = 2, xlab = xlabel, ylab = "observed meth proportion")
points(d[minus]$Cpos, d[minus]$prop, col = 4)
points(d[reads<min_reads]$Cpos, rep_len(50, length(d[reads<min_reads]$Cpos)), col = "gray65", pch = "|")
lines(x = c(0,9999999999), y = c(50,50), lty = 2)
cat("annotation region infos:\n ")
print(Annotations_dataframe[n])
}
show_annotation_region(1, data_H1, Enhancers)
show_annotation_region <- function(n, data, Annotations_dataframe,  min_reads = 2)
{
d = get_annotation_region(n, data)
d[reads<min_reads]$prop = NA
minus <- d$strand=="-"
plus <- d$strand=="+"
xlabel = paste("nucleotide position on ", as.character(Annotations_dataframe[n]$chr))
plot(d[plus]$Cpos, d[plus]$prop, ylim = c(0,100), col = 2, xlab = xlabel, ylab = "observed meth proportion")
points(d[minus]$Cpos, d[minus]$prop, col = 4)
points(d[reads<min_reads]$Cpos, rep_len(50, length(d[reads<min_reads]$Cpos)), col = "gray65", pch = "|")
lines(x = c(0,9999999999), y = c(50,50), lty = 2)
cat("annotation region infos:\n ")
print(Annotations_dataframe[n])
}
show_annotation_region(1, data_H1, Enhancers)
show_annotation_region(1, data_H1, Annotations_dataframe = Enhancers)
get_annotation_region <- function(n, data, Annotations_dataframe)
{
i = Annotations_dataframe[n]
filter_annotation_region(as.character(i$chr), i$start, i$end, data)
}
show_annotation_region <- function(n, data, Annotations_dataframe,  min_reads = 2)
{
d = get_annotation_region(n, data)
d[reads<min_reads]$prop = NA
minus <- d$strand=="-"
plus <- d$strand=="+"
xlabel = paste("nucleotide position on ", as.character(Annotations_dataframe[n]$chr))
plot(d[plus]$Cpos, d[plus]$prop, ylim = c(0,100), col = 2, xlab = xlabel, ylab = "observed meth proportion")
points(d[minus]$Cpos, d[minus]$prop, col = 4)
points(d[reads<min_reads]$Cpos, rep_len(50, length(d[reads<min_reads]$Cpos)), col = "gray65", pch = "|")
lines(x = c(0,9999999999), y = c(50,50), lty = 2)
cat("annotation region infos:\n ")
print(Annotations_dataframe[n])
}
compare_annotation_region <- function(n, Annotations_dataframe, min_reads = 5, ...)
{
par(mfrow=c(length(list(...)),1))
for(d in list(...))
{
show_annotation_region(n, d, Annotations_dataframe, min_reads = min_reads)
}
}
get_annotation_region_ranges <- function(data, min_reads = 2, Annotations_dataframe)
{
cat("\npreprocessing . . .\n")
d = sum_strands(data)
d = d[reads>=min_reads, chr, Cpos]
l_isl = length(Annotations_dataframe$start)
l_data = length(data$prop)
ranges = array(dim = c(l_isl,2))
cat("computing indexes\n")
indexes = mcmapply(1:l_isl, mc.silent = F, mc.cores = 1, FUN =  function(n)
{
cat(n," ")
i_start = Annotations_dataframe[n, start]
i_end = Annotations_dataframe[n, end]
i_chr = Annotations_dataframe[n, chr]
s = match()
c(d[Cpos = ])
})
}
show_annotation_region(1)
show_annotation_region()
show_annotation_region <- function(n, data, Annotations_dataframe,  min_reads = 2)
{
d = get_annotation_region(n, data, Annotations_dataframe)
d[reads<min_reads]$prop = NA
minus <- d$strand=="-"
plus <- d$strand=="+"
xlabel = paste("nucleotide position on ", as.character(Annotations_dataframe[n]$chr))
plot(d[plus]$Cpos, d[plus]$prop, ylim = c(0,100), col = 2, xlab = xlabel, ylab = "observed meth proportion")
points(d[minus]$Cpos, d[minus]$prop, col = 4)
points(d[reads<min_reads]$Cpos, rep_len(50, length(d[reads<min_reads]$Cpos)), col = "gray65", pch = "|")
lines(x = c(0,9999999999), y = c(50,50), lty = 2)
cat("annotation region infos:\n ")
print(Annotations_dataframe[n])
}
show_annotation_region(1,data_H1, Enhancers)
show_annotation_region(2,data_H1, Enhancers)
show_annotation_region(3,data_H1, Enhancers)
show_annotation_region(4, data_H1, Enhancers)
show_annotation_region(5, data_H1, Enhancers)
show_annotation_region(6, data_H1, Enhancers)
show_annotation_region(7, data_H1, Enhancers)
show_annotation_region(8, data_H1, Enhancers)
show_annotation_region(855, data_H1, Enhancers)
show_annotation_region(8556, data_H1, Enhancers)
show_annotation_region(856, data_H1, Enhancers)
show_annotation_region(8561, data_H1, Enhancers)
show_annotation_region(85, data_H1, Enhancers)
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
gc()
return(r)
}
a = annotation_regions_meth_data(data_H1, annotation_region_meth_counter1, Enhancers[1:10,], cores = 1)
a
a = annotation_regions_meth_data(data_H1, annotation_region_meth_counter1, Enhancers[1:10,], cores = 4)
Enhancers
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
r = rbind(r, Annotations_dataframe$id)
gc()
return(r)
}
a = annotation_regions_meth_data(data_H1, annotation_region_meth_counter1, Enhancers[1:5,], cores = 1)
a
Enhancers$id
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
r = rbind(r, Annotations_dataframe$id[1:5])
gc()
return(r)
}
a = annotation_regions_meth_data(data_H1, annotation_region_meth_counter1, Enhancers[1:5,], cores = 1)
a
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
r = cbind(r, Annotations_dataframe$id[1:5])
gc()
return(r)
}
a
a = annotation_regions_meth_data(data_H1, annotation_region_meth_counter1, Enhancers[1:5,], cores = 1)
a
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
r = cbind(r, id=Annotations_dataframe$id[1:5])
gc()
return(r)
}
a
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
r = cbind(r, id=Annotations_dataframe$id[1:5])
gc()
return(r)
}
a = annotation_regions_meth_data(data_H1, annotation_region_meth_counter1, Enhancers[1:5,], cores = 1)
a
order(c(1,2,3))
order(c(4,1,2,3))
order(a$id)
a[order(a$id), ]
Enhancers[order(Enhancers$id),]
annotation_regions_meth_data <- function(data, annotation_region_meth_counter, Annotations_dataframe, cores = 1)
{
#load("../../MethylationCode/MethylationData/CpGislands.Rdata")
d = sum_strands(data)
l = length(Annotations_dataframe$start)
cat("\nprocessing . . .\n")
methylation_prop = mcmapply(1:l, mc.preschedule = T, mc.cores = cores, FUN =  function(n)
{
cat(n," ")
annotation_region_meth_counter(get_annotation_region(n, d, Annotations_dataframe))
})
r = data.frame(t(methylation_prop))
colnames(r) <- c("prop", "meth count", "valid sites")
r = cbind(r, id=Annotations_dataframe$id)
gc()
return(r)
}
aggregate <- function(d, bin_size, chromosome, limiter = 99999999)
{
df = filter_chromosome(d,chromosome)
l = max(df$Cpos)
f = min(df$Cpos)
len = floor((l-f)/bin_size)
len = min(len,limiter)
cat("len: ", len)
starting_points = (((1:len)-1)*bin_size)+f
sapply(starting_points, function(s)
{
mean(df[df$Cpos>=s & df$Cpos<(s+bin_size)]$prop, na.rm = T)
})
}
filter_annotation_region <- function(chromosome, start, end, data)
{
data[chr==chromosome & Cpos>=start & Cpos<=end]
}
############################################################
#file = "../../MethylationCode/MethylationData/enhancer.bed"
#Enhancers <- fread(file = file,verbose=F, showProgress=T, stringsAsFactors = T)
#colnames(CpGislands) <- c("bin","chr", "start", "end", "name", "length", "cpgNum", "gcNum", "perCpG", "perGc", "obsExp")
save(file = "../../MethylationCode/MethylationData/Enhancers.Rdata", Enhancers)
Enhancers
load(Enhancers)
load("../../MethylationCode/MethylationData/Enhancers.Rdata")
Enhancers
